
-- 1. Suppression et Création de la base
DROP DATABASE IF EXISTS tifosi;
CREATE DATABASE tifosi CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- 2. Création de l’utilisateur et attribution des droits
CREATE USER 'tifosi'@'localhost' IDENTIFIED BY 'MotDePasseFort123!';
GRANT ALL PRIVILEGES ON tifosi.* TO 'tifosi'@'localhost';
FLUSH PRIVILEGES;

-- Utilisation de la base de données
USE tifosi;


-- ÉTAPE 2 : CRÉATION DES TABLES PRINCIPALES 


-- Table: ingredient
CREATE TABLE ingredient (
    id_ingredient INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(50) NOT NULL UNIQUE
);

-- Table: marque
CREATE TABLE marque (
    id_marque INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(50) NOT NULL UNIQUE
);

-- Table: focaccia 
CREATE TABLE focaccia (
    id_focaccia INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(50) NOT NULL UNIQUE,
    prix DECIMAL(5,2) NOT NULL CHECK (prix >= 0)
);

-- Table: menu
CREATE TABLE menu (
    id_menu INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(50) NOT NULL UNIQUE,
    prix DECIMAL(5,2) NOT NULL CHECK (prix >= 0)
);

-- Table: client
CREATE TABLE client (
    id_client INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(50) NOT NULL,
    email VARCHAR(50) NOT NULL UNIQUE,
    code_postal INT NOT NULL CHECK (code_postal BETWEEN 1000 AND 99999)
);


-- ÉTAPE 3 : CRÉATION DES TABLES DÉPENDANTES (AVEC CLÉS ÉTRANGÈRES)


-- Table: boisson (Dépend de marque pour l'association 'appartient')
CREATE TABLE boisson (
    id_boisson INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(50) NOT NULL,
    id_marque INT NOT NULL,

    CONSTRAINT fk_boisson_marque
        FOREIGN KEY (id_marque) REFERENCES marque(id_marque)
        ON DELETE RESTRICT ON UPDATE CASCADE
);


-- ÉTAPE 4 : CRÉATION DES TABLES D'ASSOCIATION (LIAISONS N,N)


-- Association : comprend (focaccia - ingredient)
CREATE TABLE comprend (
    id_focaccia INT NOT NULL,
    id_ingredient INT NOT NULL,
    quantite INT NOT NULL CHECK (quantite > 0),

    PRIMARY KEY (id_focaccia, id_ingredient),

    CONSTRAINT fk_comprend_focaccia
        FOREIGN KEY (id_focaccia) REFERENCES focaccia(id_focaccia)
        ON DELETE CASCADE ON UPDATE CASCADE,

    CONSTRAINT fk_comprend_ingredient
        FOREIGN KEY (id_ingredient) REFERENCES ingredient(id_ingredient)
        ON DELETE CASCADE ON UPDATE CASCADE
);

-- Association : est_constitue (menu - focaccia)
CREATE TABLE est_constitue (
    id_menu INT NOT NULL,
    id_focaccia INT NOT NULL,

    PRIMARY KEY (id_menu, id_focaccia),

    CONSTRAINT fk_estconst_menu
        FOREIGN KEY (id_menu) REFERENCES menu(id_menu)
        ON DELETE CASCADE ON UPDATE CASCADE,

    CONSTRAINT fk_estconst_focaccia
        FOREIGN KEY (id_focaccia) REFERENCES focaccia(id_focaccia)
        ON DELETE CASCADE ON UPDATE CASCADE
);

-- Association : contient (menu - boisson)
CREATE TABLE contient (
    id_menu INT NOT NULL,
    id_boisson INT NOT NULL,

    PRIMARY KEY (id_menu, id_boisson),

    CONSTRAINT fk_contient_menu
        FOREIGN KEY (id_menu) REFERENCES menu(id_menu)
        ON DELETE CASCADE ON UPDATE CASCADE,

    CONSTRAINT fk_contient_boisson
        FOREIGN KEY (id_boisson) REFERENCES boisson(id_boisson)
        ON DELETE CASCADE ON UPDATE CASCADE
);

-- Association : achete (client - menu)
CREATE TABLE achete (
    id_client INT NOT NULL,
    id_menu INT NOT NULL,
    date_achat DATE NOT NULL,

    PRIMARY KEY (id_client, id_menu, date_achat),

    CONSTRAINT fk_achete_client
        FOREIGN KEY (id_client) REFERENCES client(id_client)
        ON DELETE CASCADE ON UPDATE CASCADE,

    CONSTRAINT fk_achete_menu
        FOREIGN KEY (id_menu) REFERENCES menu(id_menu)
        ON DELETE CASCADE ON UPDATE CASCADE
);



